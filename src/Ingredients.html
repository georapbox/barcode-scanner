<html lang="en">
<link rel="stylesheet" type="text/css" href="./css/main.css">

<header class="navigation">
    <a href= "./index.html"><h1 class="header-title">Barcode Scanner App</h1></a>   
    <ul id = "Header List" class = "navigationList"> 
      <li class="navigationListItem" id="1"><a href="./index.html">Home </a></li>
      <li class="navigationListItem" id="2"><a href="./Ingredients.html">Ingredients </a></li>
      <li class="navigationListItem" id="3"><a href="./recipes.html">Recipes </a></li>
      <li class="navigationListItem" id="4"><a href="./help.html">Help </a></li>
      <li class="navigationListItem">
        <form onSubmit={submitAnswer}>
        <input type="text" value=""></input>
        <input type="submit" value="Search"></input>
        </form>
      </li>
    </ul>
  </header>

<div class="body">
  <h1 class="header-title">Ingredients</h1>
  <section id="user-ingredients">
    <h2>Your Scanned Items</h2>
    <div id="user-ingredients-list">Loading...</div>
  </section>
</div>

<script type="module">
  import { initAuth, getCurrentUser } from './js/services/firebase-auth.js';
  import { getHistory } from './js/services/storage.js';

  async function fetchUserIngredients() {
    const container = document.getElementById('user-ingredients-list');
    container.innerHTML = 'Loading...';

    // 1) Try to use firebase-auth module (works when Firebase client is configured)
    try {
      let user = null;
      try { user = await initAuth(); } catch (e) { /* ignore */ }

      if (!user) user = getCurrentUser();
      let token = null;

      if (user && typeof user.getIdToken === 'function') {
        try { token = await user.getIdToken(); } catch (e) { console.warn('user.getIdToken failed', e); }
      }

      // 2) If no token from firebase-auth above, try reading token React might have saved
      if (!token) {
        // React snippet (see next section) stores keys `barcode-scanner/idToken` and `barcode-scanner/uid`
        token = localStorage.getItem('barcode-scanner/idToken') || null;
      }

      // 3) If we have a token, call the proxy endpoint
      if (token) {
        try {
          const res = await fetch('/user/ingredients', {
            method: 'GET',
            headers: { Authorization: `Bearer ${token}` }
          });
          if (res.ok) {
            const json = await res.json();
            renderItems(json.items || []);
            return;
          } else {
            console.warn('/user/ingredients returned', res.status);
            // If server says token invalid or Firestore not configured, fallthrough to local fallback
          }
        } catch (err) {
          console.error('Fetch /user/ingredients failed', err);
        }
      }

      // 4) No valid server token or server refused: show local IndexedDB history fallback
      try {
        const [, history = []] = await getHistory();
        // Optionally filter by uid if React stored one in localStorage
        const uid = localStorage.getItem('barcode-scanner/uid') || null;
        let items = history.map(h => (typeof h === 'string' ? { title: h, addedAt: h.addedAt } : { title: h.title || h.value || '(unknown)', addedAt: h.addedAt || h.addedAt }));
        if (uid) {
          // If your local-saves include userId field, filter by it
          items = items.filter(it => !it.userId || it.userId === uid ? true : false);
        }
        // De-duplicate and show
        items = items.slice(0, 200);
        renderItems(items);
        return;
      } catch (err) {
        console.error('Local fallback failed', err);
      }

      // Final fallback message
      container.innerHTML = '<p>Sign in (in the React UI) to view your scanned items, or enable server-side Firestore.</p>';

    } catch (err) {
      console.error('Unexpected error', err);
      document.getElementById('user-ingredients-list').innerHTML = '<p>Error loading items.</p>';
    }
  }

  function renderItems(items) {
    const container = document.getElementById('user-ingredients-list');
    container.innerHTML = '';
    if (!items || items.length === 0) {
      container.innerHTML = '<p>No scanned items yet.</p>';
      return;
    }
    const ul = document.createElement('ul');
    for (const it of items) {
      const title = it.title || it.value || '(unknown)';
      const when = it.addedAt ? ` â€” ${new Date(it.addedAt).toLocaleString()}` : '';
      const li = document.createElement('li');
      li.textContent = `${title}${when}`;
      ul.appendChild(li);
    }
    container.appendChild(ul);
  }

  document.addEventListener('DOMContentLoaded', fetchUserIngredients);
</script>

  <footer class="navigation">
    <ul id = "Navigation Footer List" class = "navigationList"> 
      <li class="navigationListItem" id="1"><a href="./about.html">About </a></li>
      <li class="navigationListItem" id="2"><a href="./faq.html">FAQ </a></li>
      <li class="navigationListItem" id="3"><a href="./contact.html">Contact </a></li>
    </ul>
</footer>

</html>